# v1.0.0 技術アーキテクチャ

## 概要
大阪万博2025予約補助Chrome/Safari拡張機能のアーキテクチャドキュメント。TypeScript + Webpack構成による複数機能の統合システム。

## モジュール構成

### エントリーポイント
- **`ts/modules/main.ts`**: メインエントリーポイント、全モジュールのimport
- **`ts/modules/app-router.ts`**: ページルーティング・初期化制御

### コア機能モジュール

#### 🎫 入場予約システム
- **`entrance-reservation-state-manager.ts`**: 統一状態管理システム（最重要）
  - ExecutionState管理（IDLE / RESERVATION_RUNNING）
  - ReservationTarget管理（時間帯・位置・セレクタ）
  - 効率モード・通知音設定
  - UnifiedAutomationManagerとの連携

- **`entrance-page-fab.ts`**: 入場予約UI（FAB）
  - FABボタン・ステータス表示
  - 予約開始・中断処理
  - 音声通知システムとの連携

- **`entrance-page-core.ts`**: 入場予約コア機能
  - モード管理・状態更新
  - カレンダー日付取得・管理
  - リロードスケジュール・中断制御

#### 🏢 パビリオン検索
- **`pavilion-search-page.ts`**: パビリオン検索支援
  - 全件読み込み・絞り込み・コピー機能
  - 高度検索（AND/OR/NOT）

#### 👥 同行者管理
- **`companion-ticket-page.ts`**: 同行者追加自動化
  - チケットID管理・保存
  - 自動画面遷移・入力処理
  - 日付選択機能

#### 🎵 音声通知
- **`audio-player.ts`**: Web Audio API音声システム
  - 8ビット風チップチューン生成
  - 成功音再生・オン/オフ切替

### ユーティリティモジュール

#### 状態・DOM管理
- **`entrance-page-state.ts`**: FAB表示状態管理
- **`entrance-page-dom-utils.ts`**: DOM要素検索・操作
- **`entrance-page-init.ts`**: 初期化判定・処理
- **`timeslot-status-detector.ts`**: 時間帯状態検出

#### システム制御
- **`processing-overlay.ts`**: 処理中オーバーレイ・UI制御
- **`unified-automation-manager.ts`**: 統一自動処理システム
- **`cache-manager.ts`**: 状態永続化・キャッシュ管理
- **`page-utils.ts`**: ページタイプ判定ユーティリティ

## アーキテクチャ設計原則

### 統一状態管理
- **中央集権**: `entrance-reservation-state-manager.ts`で状態を一元管理
- **責務分離**: UI・ロジック・状態を明確に分離
- **依存注入**: CacheManager等の依存性をDI形式で注入

### モジュール間通信
- **イベント駆動**: カスタムイベントによる疎結合
- **インターフェース統一**: 共通型定義による型安全性
- **循環依存回避**: 適切なimport設計による依存関係管理

### 拡張性・保守性
- **機能分離**: 各画面・機能を独立モジュール化
- **設定外部化**: localStorage・設定オブジェクトによる設定管理
- **エラーハンドリング**: 統一的なエラー処理・回復機構

## 技術スタック

### 開発環境
- **TypeScript**: 型安全・大規模開発対応
- **Webpack**: モジュールバンドル・最適化
- **SCSS**: CSS管理・コンポーネント化

### ブラウザ拡張
- **Manifest V3**: Chrome Extension最新仕様
- **Content Script**: ページ内DOM操作・機能注入
- **Storage API**: 設定・状態の永続化

### ブラウザAPI
- **Web Audio API**: 8ビット風音声生成
- **DOM API**: 高度なDOM操作・検索
- **Storage API**: localStorage・セッション管理

## 削除済み機能

### 時間帯監視機能（v0.x）
- **削除理由**: 入場予約自動化に統合・重複機能排除
- **削除時期**: 2024年後半
- **後継**: `entrance-reservation-state-manager.ts`による統一管理

## 依存関係図

```
main.ts
├── app-router.ts (ルーティング・初期化)
│   ├── pavilion-search-page.ts
│   ├── entrance-page-init.ts
│   │   └── entrance-page-fab.ts
│   │       └── entrance-reservation-state-manager.ts ⭐️
│   │           └── unified-automation-manager.ts
│   └── companion-ticket-page.ts
├── processing-overlay.ts (UI制御)
├── audio-player.ts (音声)
└── cache-manager.ts (永続化)
```

## 実行フロー

### 1. 初期化
1. `app-router.ts`がページタイプ判定
2. 各画面の初期化関数呼び出し
3. 対応するFAB・機能モジュール読み込み

### 2. 入場予約実行
1. ユーザーFABクリック
2. `entrance-page-fab.ts`が開始処理
3. `entrance-reservation-state-manager.ts`で状態管理
4. `unified-automation-manager.ts`で自動処理実行

### 3. 状態同期
1. DOM変更検知
2. 状態管理システム更新
3. UI・表示の同期更新