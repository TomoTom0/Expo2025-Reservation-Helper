# WIP - 作業中のタスク

## 完了した機能

### パビリオン予約自動化システム ✅

#### 当日パビリオン予約ダイアログ ✅
- パビリオン検索ページでFABサブボタン押下により当日予約ダイアログを表示
- 万博API（expo.ebii.net/api/data）を利用してパビリオン情報を取得
- CORS対策として Chrome拡張機能とUserScript両方に対応

#### 監視・即時予約システム ✅
- **即時予約**: 空き時間帯クリック → 予約ページを開き自動で時間選択・申込実行
- **監視予約**: 満員時間帯クリック → 監視対象に追加、定期的にAPI確認して空きが出れば自動予約
- **監視スケジューラー**: 毎分00,15,30,45秒での定期実行（設定変更可能）
- **順序管理**: 監視対象の選択順序を保持し、同時空発生時の優先度制御

#### UI仕様 ✅
- **ヘッダー**: タイトル + 更新ボタン（右上）
- **制御エリア**: 空きのみトグルボタン（ON/OFF切り替え、色で状態表示）
- **パビリオンリスト**: 
  - 空き時間帯：🟢空きあり 🟡残りわずか（クリックで即時予約）
  - 満員時間帯：🔴（クリックで監視対象選択、選択状態を視覚表示）
  - **選択ボタン**（空きのみOFF時のみ表示）：パビリオンの満員時間を一括選択
- **フッター**: 
  - 閉じるボタン + 空きのみボタン
  - **選択解除ボタン**（空きのみOFF時のみ表示）：全監視対象をクリア
  - **監視開始ボタン**（空きのみOFF時のみ表示）：監視機能を開始/停止

#### 技術実装 ✅
- **4つの新しいモジュール**:
  - `monitoring-scheduler.ts`: 設定可能な監視タイミング制御
  - `monitoring-cache.ts`: 順序ベースの監視対象管理
  - `monitoring-service.ts`: API監視と自動予約実行
  - `immediate-reservation.ts`: 即時予約機能
- **正しいURL実装**: `expoTable.js`を参照した完全なパラメータ指定
- **SCSSスタイリング**: インラインスタイルを廃止、適切なCSS設計
- **リダイレクト異常検知**: ページタイトル完全一致での異常判定と元ページ復旧

#### 確認済み仕様
- **遷移先URL**: `https://ticket.expo2025.or.jp/event_time/?id=${ticketIds}&event_id=${pavilionCode}&screen_id=108&lottery=5&entrance_date=${formatDateToYMD()}`
- **ticketIds取得**: URLパラメータ`id`から取得
- **監視タイミング**: 毎分00,15,30,45秒（容易に変更可能）
- **異常復旧**: タイトル不一致時に元のパビリオン検索ページに自動復帰

## 現在の作業

### リダイレクト異常判定ロジックの修正 🔄

#### 問題の特定
実際のログ分析により判明した問題：
```
📍 ページ検知: reservation_time - https://ticket.expo2025.or.jp/event_time/?...
⚠️ ページ復帰情報がないため、リダイレクト検知をスキップ  ← 問題1
⏳ ページ準備完了を待機中... （15秒間待機）              ← 問題2
```

#### 根本的な誤解の修正
1. **問題1**: ページ復帰情報がないのは当然で、リダイレクト判定スキップは不要
2. **問題2**: ページが安定しているのに期待する要素（時間ラジオボタン、submitボタン）がない → **これこそが異常リダイレクト**

#### 正しい判定ロジック
```typescript
// 現在（間違い）：ページ復帰情報がないからリダイレクト判定スキップ
if (!pageReturnInfo) {
    this.log('⚠️ リダイレクト検知をスキップ');
    return;
}

// 正しい判定：ページが安定した時点で要素存在チェック
const pageInfo = this.pageDetector.extractPageInfo();
if (pageInfo.type === 'reservation_time' && !pageInfo.isReady) {
    // ページタイプは正しく検知されたが必要な要素がない = 異常リダイレクト
    throw new Error('異常リダイレクト検知');
}
```

#### 修正すべき箇所
1. **AutomationEngine.checkRedirectAbnormality()**: 不要なスキップ条件を削除
2. **PageDetector.checkReservationPageReady()**: 要素が見つからない場合の即座判定
3. **15秒待機の削除**: ページ準備判定で即座に異常リダイレクト検知

#### 期待される動作
- ページ安定化（500ms x4回）完了
- 期待する要素の存在チェック
- 要素なし → 即座に異常リダイレクト判定 → 元ページ復帰
- 要素あり → 自動予約処理継続

#### 完了した最適化項目
- **console.log削減**: 重複ログ出力を削減、状態変化時のみ出力
- **UI表示制御**: 監視関連ボタンを「空きのみOFF」時のみ表示
- **URL修正**: 正しいパラメータでの予約ページ遷移

#### 完了した項目
- **リダイレクト異常対応の改良**: pending/processing状態を統一的に扱う最適化 ✅
- **予約結果通知システム**: 高さ固定・説明文置換式の通知UI実装 ✅

## 現在のバグ修正

### お気に入り取得時のフィルター機能不具合 🔄
- [ ] お気に入り取得後にフィルター（空きのみ表示）が機能しない問題を修正

## 次のタスク：高度な予約機能実装

### 1. 時間帯選択時のタイムスタンプ記録
- [ ] 時間帯ボタン選択時に`data-time-selected`属性にunixtime追加
- [ ] 選択解除時に属性削除  
- [ ] パビリオンチェックボックス選択時の昇順タイムスタンプ設定

### 2. 順次予約機能
- [ ] 複数選択時の順次予約処理実装
- [ ] 誤操作防止オーバーレイの拡張
- [ ] 間隔設定ドロップダウン（1,5,15,30,60秒）
- [ ] 1,5秒間隔の180回制限実装
- [ ] **循環処理**: 対象が1週したら最初の要素から繰り返し

### 3. 監視モード  
- [ ] 予約/監視モード切り替えUI
- [ ] 監視モード時の定期更新処理
- [ ] 空き検出→自動予約機能
- [ ] 監視間隔設定（5,15,30,60秒）
- [ ] 5,15秒間隔の180回制限実装
- [ ] **循環処理**: 対象が1週したら最初の要素から繰り返し

### 調査項目
1. 時間帯ボタンの選択処理メソッド
2. 誤操作防止オーバーレイの現在の実装
3. 予約処理の現在の流れ
4. タイムスタンプ管理の方法

### 技術的課題
1. DOM属性管理の最適な方法
2. 定期処理のメモリリーク対策
3. 180回制限のカウンター管理
4. 監視モード時のパフォーマンス考慮